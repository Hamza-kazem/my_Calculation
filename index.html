<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام المحاسبة - تصميم محسن</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Tajawal -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .main-content {
            transition: margin-right 0.3s ease-in-out;
        }
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: #475569; /* slate-600 */
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            margin: 0.25rem 0;
        }
        .nav-link:hover {
            background-color: #f1f5f9; /* slate-100 */
            color: #0f172a; /* slate-900 */
        }
        .nav-link.active {
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .nav-link.active svg {
            color: #ffffff !important;
        }
        .nav-link svg {
            margin-left: 0.75rem;
            color: #64748b; /* slate-500 */
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-input, .form-select {
            background-color: #f8fafc; /* slate-50 */
            border: 1px solid #e2e8f0; /* slate-200 */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: all 0.2s ease-in-out;
            width: 100%;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
            background-color: #ffffff;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            transform: translateY(0);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
        }
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #e2e8f0; color: #1e293b; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-success { background-color: #16a34a; color: white; }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05), 0 1px 2px -1px rgba(0,0,0,0.05);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .card-icon {
            padding: 0.75rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            font-weight: 600;
            border-bottom: 2px solid transparent;
            color: #64748b;
        }
        .tab-btn.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        .debt-panel.hidden {
            display: none;
        }
        .modal-backdrop {
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; font-size: 12pt; }
            #print-controls, #app-container aside, #app-container main > *:not(#print-modal) { display: none; }
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Login Page -->
    <div id="login-page" class="flex items-center justify-center h-screen bg-slate-100">
        <div class="w-full max-w-sm bg-white p-8 rounded-xl shadow-lg">
            <div class="text-center mb-8">
                <span class="inline-block p-3 bg-indigo-100 rounded-full">
                    <i data-feather="dollar-sign" class="text-indigo-600"></i>
                </span>
                <h1 id="auth-title" class="text-3xl font-bold text-slate-800 mt-4">أهلاً بك</h1>
                <p id="auth-subtitle" class="text-slate-500">سجل الدخول إلى نظام حساباتي</p>
            </div>
            <form id="auth-form" class="space-y-4">
                <div><input type="email" id="email" class="form-input" placeholder="البريد الإلكتروني" required></div>
                <div><input type="password" id="password" class="form-input" placeholder="كلمة المرور" required></div>
                <div id="auth-error" class="text-red-500 text-sm text-center hidden pt-2"></div>
                <div class="pt-4">
                    <button type="submit" id="auth-btn" class="btn btn-primary w-full">تسجيل الدخول</button>
                </div>
            </form>
            <div class="text-center mt-6 text-sm">
                <span id="toggle-text" class="text-slate-500">هل لا تمتلك حساب؟ </span>
                <button type="button" id="toggle-auth-mode-btn" class="font-semibold text-indigo-600 hover:text-indigo-500 focus:outline-none">إنشاء حساب جديد</button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside class="sidebar bg-white w-64 p-4 border-l border-slate-200 fixed inset-y-0 right-0">
                <div class="text-center mb-8"><a href="#" class="flex items-center justify-center gap-2 text-2xl font-extrabold text-slate-800"><i data-feather="dollar-sign" class="text-indigo-600"></i><span>حساباتي</span></a></div>
                <nav>
                    <a href="#dashboard" class="nav-link active"><i data-feather="home"></i><span>لوحة التحكم</span></a>
                    <a href="#income" class="nav-link"><i data-feather="arrow-down-circle"></i><span>وصل دخل</span></a>
                    <a href="#expense" class="nav-link"><i data-feather="arrow-up-circle"></i><span>وصل صرف</span></a>
                    <a href="#purchase-order" class="nav-link"><i data-feather="shopping-cart"></i><span>وصل مشتريات</span></a>
                    <a href="#debts" class="nav-link"><i data-feather="list"></i><span>إدارة الديون</span></a>
                    <a href="#transactions" class="nav-link"><i data-feather="archive"></i><span>السجلات</span></a>
                </nav>
                 <div class="absolute bottom-5 right-0 left-0 px-4">
                    <div class="text-center text-xs text-slate-400 mb-4"><p>المستخدم الحالي:</p><p id="user-email-display" class="font-mono break-all text-slate-500">...</p></div>
                    <button id="logout-btn" class="btn btn-secondary w-full text-sm py-2"><i data-feather="log-out"></i><span>تسجيل الخروج</span></button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content flex-1 mr-64 p-6 md:p-8 lg:p-10 overflow-y-auto">
                <!-- Page: Dashboard -->
                <div id="dashboard-page" class="page active">
                    <h1 class="text-3xl font-bold text-slate-800 mb-8">لوحة التحكم</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6">
                        <div class="card"><div class="card-icon bg-cyan-100 text-cyan-600"><i data-feather="trending-up"></i></div><div><h2 class="text-sm font-medium text-slate-500">إجمالي الدخل</h2><p id="total-income" class="text-2xl font-bold mt-1 text-slate-800">0.00 د.ع</p></div></div>
                        <div class="card"><div class="card-icon bg-rose-100 text-rose-600"><i data-feather="trending-down"></i></div><div><h2 class="text-sm font-medium text-slate-500">إجمالي المصروفات</h2><p id="total-expenses" class="text-2xl font-bold mt-1 text-slate-800">0.00 د.ع</p></div></div>
                        <div class="card"><div class="card-icon bg-indigo-100 text-indigo-600"><i data-feather="briefcase"></i></div><div><h2 class="text-sm font-medium text-slate-500">الرصيد الصافي</h2><p id="net-balance" class="text-2xl font-bold mt-1 text-slate-800">0.00 د.ع</p></div></div>
                        <div class="card"><div class="card-icon bg-emerald-100 text-emerald-600"><i data-feather="arrow-down-left"></i></div><div><h2 class="text-sm font-medium text-slate-500">ديون مستحقة لك</h2><p id="total-receivables" class="text-2xl font-bold mt-1 text-slate-800">0.00 د.ع</p></div></div>
                        <div class="card"><div class="card-icon bg-amber-100 text-amber-600"><i data-feather="arrow-up-right"></i></div><div><h2 class="text-sm font-medium text-slate-500">ديون مطلوبة منك</h2><p id="total-payables" class="text-2xl font-bold mt-1 text-slate-800">0.00 د.ع</p></div></div>
                    </div>
                    <div class="mt-10 grid grid-cols-1 lg:grid-cols-5 gap-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm"><h2 class="text-xl font-bold text-slate-800 mb-4">الدخل والمصروفات</h2><div class="h-64 md:h-80 relative"><canvas id="transactionsChart"></canvas></div></div>
                        <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-sm"><h2 class="text-xl font-bold text-slate-800 mb-4">أحدث العمليات</h2><div id="recent-transactions-list" class="space-y-4"><p class="text-center text-slate-500 py-4">لا توجد عمليات لعرضها.</p></div></div>
                    </div>
                </div>

                <!-- Page: New Income/Expense/Purchase Order -->
                <div id="income-page" class="page"></div>
                <div id="expense-page" class="page"></div>
                <div id="purchase-order-page" class="page"></div>

                <!-- Page: Debts -->
                <div id="debts-page" class="page">
                    <h1 class="text-3xl font-bold text-slate-800 mb-8">إدارة الديون</h1>
                    <div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-8">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">إضافة دين جديد</h2>
                        <form id="debt-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                <div><label for="debt-type" class="block text-sm font-medium text-slate-700 mb-1">نوع الدين</label><select id="debt-type" class="form-select" required><option value="receivable">دين مستحق لي (سأقبض)</option><option value="payable">دين مطلوب مني (سأدفع)</option></select></div>
                                <div><label for="debt-party" class="block text-sm font-medium text-slate-700 mb-1">اسم الطرف الآخر</label><input type="text" id="debt-party" class="form-input" required></div>
                                <div><label for="debt-amount" class="block text-sm font-medium text-slate-700 mb-1">المبلغ</label><input type="number" id="debt-amount" class="form-input" min="0" step="any" required></div>
                                <div><label for="debt-date" class="block text-sm font-medium text-slate-700 mb-1">التاريخ</label><input type="date" id="debt-date" class="form-input" required></div>
                            </div>
                            <div class="mt-4 flex items-center gap-4">
                               <button type="submit" class="btn btn-primary">إضافة الدين</button>
                               <div id="debt-form-feedback" class="text-sm font-semibold"></div>
                            </div>
                        </form>
                    </div>
                    <div class="mb-6"><div class="border-b border-slate-200"><nav id="debt-tabs" class="-mb-px flex gap-6" aria-label="Tabs"><button type="button" data-tab="receivables" class="tab-btn active">ديون مستحقة لك</button><button type="button" data-tab="payables" class="tab-btn">ديون مطلوبة منك</button></nav></div></div>
                    <div>
                        <div id="receivables-panel" class="debt-panel space-y-4"></div>
                        <div id="payables-panel" class="debt-panel hidden space-y-4"></div>
                    </div>
                </div>

                <!-- Page: Transactions -->
                <div id="transactions-page" class="page">
                    <h1 class="text-3xl font-bold text-slate-800 mb-8">سجل العمليات</h1>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden"><table class="w-full"><thead class="bg-slate-50 border-b"><tr><th class="p-4 text-right font-bold text-slate-600">النوع</th><th class="p-4 text-right font-bold text-slate-600">التاريخ</th><th class="p-4 text-right font-bold text-slate-600">الجهة</th><th class="p-4 text-right font-bold text-slate-600">المبلغ</th><th class="p-4 text-center font-bold text-slate-600">الإجراءات</th></tr></thead><tbody id="transactions-table-body"></tbody></table></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Print Modal -->
    <div id="print-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50 modal-backdrop">
        <div class="bg-white w-full max-w-4xl mx-auto rounded-lg modal-content">
            <div id="print-area" class="p-10"></div>
            <div id="print-controls" class="p-4 bg-slate-50 text-left rounded-b-lg border-t"><button onclick="window.print()" class="btn btn-primary">طباعة</button><button id="close-print-modal-btn" class="btn btn-secondary mr-2">إغلاق</button></div>
        </div>
    </div>

    <!-- Confirmation Modal (for transaction deletion) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50 modal-backdrop">
        <div class="bg-white w-full max-w-sm mx-auto rounded-lg shadow-lg p-6 text-center modal-content">
            <h2 id="confirmation-title" class="text-xl font-bold text-slate-800 mb-2">هل أنت متأكد؟</h2>
            <p id="confirmation-message" class="text-slate-600 mb-6">لا يمكن التراجع عن هذا الإجراء.</p>
            <div id="confirmation-error" class="text-red-500 text-sm mb-4 hidden"></div>
            <div class="flex justify-center gap-4">
                <button id="confirm-btn" class="btn btn-danger">
                    <span class="btn-text">تأكيد الحذف</span>
                    <i data-feather="loader" class="spinner hidden"></i>
                </button>
                <button id="cancel-btn" class="btn btn-secondary">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Debt Details Modal -->
    <div id="debt-details-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50 modal-backdrop">
        <div class="bg-white w-full max-w-2xl mx-auto rounded-lg shadow-lg modal-content overflow-hidden">
            <div class="p-6 border-b">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-slate-500" id="debt-modal-type-text"></p>
                        <h2 class="text-2xl font-bold text-slate-800" id="debt-modal-party-name"></h2>
                    </div>
                    <button id="close-debt-modal-btn" class="text-slate-400 hover:text-slate-600">&times;</button>
                </div>
                 <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                    <div><p class="text-sm text-slate-500">المبلغ الإجمالي</p><p class="font-bold text-lg text-slate-700" id="debt-modal-total"></p></div>
                    <div><p class="text-sm text-slate-500">المبلغ المدفوع</p><p class="font-bold text-lg text-green-600" id="debt-modal-paid"></p></div>
                    <div><p class="text-sm text-slate-500">المبلغ المتبقي</p><p class="font-bold text-lg text-red-600" id="debt-modal-remaining"></p></div>
                </div>
            </div>
            <div class="p-6 bg-slate-50 max-h-[40vh] overflow-y-auto">
                <h3 class="font-bold text-slate-700 mb-4">سجل الدفعات</h3>
                <div id="debt-payments-list" class="space-y-3"></div>
            </div>
            <div class="p-6 border-t">
                <form id="add-payment-form" class="mb-4">
                    <h3 class="font-bold text-slate-700 mb-3">إضافة دفعة جديدة</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                        <input type="hidden" id="payment-debt-id">
                        <div><label class="block text-xs font-medium text-slate-600 mb-1">مبلغ الدفعة</label><input type="number" id="payment-amount" class="form-input" min="0" step="any" required></div>
                        <div><label class="block text-xs font-medium text-slate-600 mb-1">تاريخ الدفعة</label><input type="date" id="payment-date" class="form-input" required></div>
                        <button type="submit" class="btn btn-success">إضافة الدفعة</button>
                    </div>
                    <div id="payment-form-feedback" class="text-sm text-red-600 mt-2"></div>
                </form>
                <div id="debt-modal-actions" class="border-t pt-4 flex justify-between items-center">
                     <button id="settle-debt-btn" class="btn btn-primary"><i data-feather="check-circle"></i>تسوية وإغلاق الدين</button>
                     <button id="delete-debt-btn" class="text-sm font-semibold text-red-600 hover:text-red-500 transition-colors duration-150">حذف الدين نهائياً</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, where, deleteDoc, doc, updateDoc, writeBatch, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB2LBQonHt7cstK6VfsM3MGlRCfeX9v5v0",
            authDomain: "my-calculation-ec9ea.firebaseapp.com",
            projectId: "my-calculation-ec9ea",
            storageBucket: "my-calculation-ec9ea.appspot.com",
            messagingSenderId: "54197879072",
            appId: "1:54197879072:web:37e18ac427d54869e55745"
        };
        const appId = 'accounting-app-with-auth';

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let userId = null;
        let transactionsCollectionRef = null;
        let debtsCollectionRef = null;
        let transactionsUnsubscribe = null;
        let debtsUnsubscribe = null;
        let debtPaymentsUnsubscribe = null;
        let allTransactions = [];
        let allDebts = [];
        let transactionsChart = null;
        let currentDebtData = {};
        let isRegisterMode = false;

        // --- DOM Elements ---
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        const userEmailDisplay = document.getElementById('user-email-display');
        const confirmationModal = document.getElementById('confirmation-modal');
        const debtDetailsModal = document.getElementById('debt-details-modal');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authSubtitle = document.getElementById('auth-subtitle');
        const authBtn = document.getElementById('auth-btn');
        const toggleAuthModeBtn = document.getElementById('toggle-auth-mode-btn');
        const toggleText = document.getElementById('toggle-text');

        // --- Utility Functions ---
        const formatCurrency = (amount) => new Intl.NumberFormat('ar-IQ', { style: 'currency', currency: 'IQD', minimumFractionDigits: 2 }).format(amount);
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' }) : '';
        const getTodayDateString = () => new Date().toISOString().split('T')[0];
        
        // --- Authentication Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userEmailDisplay.textContent = user.email;
                loginPage.classList.add('hidden');
                appContainer.classList.remove('hidden');
                setupFirestoreListeners();
                handleInitialLoad();
            } else {
                userId = null;
                loginPage.classList.remove('hidden');
                appContainer.classList.add('hidden');
                if (transactionsUnsubscribe) transactionsUnsubscribe();
                if (debtsUnsubscribe) debtsUnsubscribe();
                if (debtPaymentsUnsubscribe) debtPaymentsUnsubscribe();
                allTransactions = []; allDebts = [];
                updateUI();
                if(transactionsChart) transactionsChart.destroy();
            }
            feather.replace();
        });

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            authError.classList.add('hidden');
            authForm.reset();
            if (isRegisterMode) {
                authTitle.textContent = 'إنشاء حساب جديد';
                authSubtitle.textContent = 'املأ البيانات التالية للبدء';
                authBtn.textContent = 'إنشاء الحساب';
                toggleText.textContent = 'هل لديك حساب بالفعل؟ ';
                toggleAuthModeBtn.textContent = 'تسجيل الدخول';
            } else {
                authTitle.textContent = 'أهلاً بك';
                authSubtitle.textContent = 'سجل الدخول إلى نظام حساباتي';
                authBtn.textContent = 'تسجيل الدخول';
                toggleText.textContent = 'هل لا تمتلك حساب؟ ';
                toggleAuthModeBtn.textContent = 'إنشاء حساب جديد';
            }
        }
        toggleAuthModeBtn.addEventListener('click', toggleAuthMode);

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.classList.add('hidden');
            const email = emailInput.value;
            const password = passwordInput.value;
            if (isRegisterMode) {
                if (password.length < 6) { authError.textContent = "كلمة المرور يجب أن تكون 6 أحرف على الأقل."; authError.classList.remove('hidden'); return; }
                try { await createUserWithEmailAndPassword(auth, email, password); } 
                catch (error) { authError.textContent = "فشل التسجيل. قد يكون البريد مستخدماً."; authError.classList.remove('hidden'); }
            } else {
                try { await signInWithEmailAndPassword(auth, email, password); } 
                catch (error) { authError.textContent = "فشل الدخول. تحقق من بياناتك."; authError.classList.remove('hidden'); }
            }
        });

        logoutBtn.addEventListener('click', async () => { try { await signOut(auth); } catch (error) { console.error("Logout failed:", error); } });

        // --- Page/Router Logic ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.toggle('active', page.id === pageId));
            navLinks.forEach(link => link.classList.toggle('active', link.hash === `#${pageId.replace('-page', '')}`));
            if (pageId === 'income-page' || pageId === 'expense-page') { renderTransactionForm(pageId.split('-')[0]); }
            else if (pageId === 'purchase-order-page') { renderPurchaseOrderForm(); } 
            else if (pageId === 'debts-page') { initDebtPage(); }
            feather.replace();
        }
        navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const pageId = link.hash.substring(1) + '-page'; showPage(pageId); window.location.hash = link.hash; }); });
        function handleInitialLoad() { const hash = window.location.hash || '#dashboard'; const pageId = hash.substring(1) + '-page'; showPage(document.getElementById(pageId) ? pageId : 'dashboard-page'); }

        // --- Firestore Listeners & UI Updates ---
        function setupFirestoreListeners() {
            if (!userId) return;
            const commonPath = `artifacts/${appId}/users/${userId}`;
            transactionsCollectionRef = collection(db, `${commonPath}/transactions`);
            debtsCollectionRef = collection(db, `${commonPath}/debts`);

            if (transactionsUnsubscribe) transactionsUnsubscribe();
            transactionsUnsubscribe = onSnapshot(query(transactionsCollectionRef), (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allTransactions.sort((a, b) => (b.date?.toDate() || 0) - (a.date?.toDate() || 0));
                updateUI();
            });

            if (debtsUnsubscribe) debtsUnsubscribe();
            debtsUnsubscribe = onSnapshot(query(debtsCollectionRef, where("status", "==", "active")), (snapshot) => {
                allDebts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allDebts.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                updateUI();
            });
        }
        
        function updateUI() {
            updateDashboard();
            renderTransactionsTable();
            renderDebtCards();
            renderChart();
            feather.replace();
        }

        function updateDashboard() {
            const totalIncome = allTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.totalAmount, 0);
            const totalExpenses = allTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.totalAmount, 0);
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('net-balance').textContent = formatCurrency(totalIncome - totalExpenses);
            
            const totalReceivables = allDebts.filter(d => d.type === 'receivable').reduce((sum, d) => sum + (d.amount - (d.paidAmount || 0)), 0);
            const totalPayables = allDebts.filter(d => d.type === 'payable').reduce((sum, d) => sum + (d.amount - (d.paidAmount || 0)), 0);
            document.getElementById('total-receivables').textContent = formatCurrency(totalReceivables);
            document.getElementById('total-payables').textContent = formatCurrency(totalPayables);

            const recentList = document.getElementById('recent-transactions-list');
            recentList.innerHTML = allTransactions.length === 0 ? '<p class="text-center text-slate-500 py-4">لا توجد عمليات لعرضها.</p>' : allTransactions.slice(0, 5).map(t => {
                let icon, color, text;
                switch(t.type) {
                    case 'income':
                        icon = 'arrow-down'; color = 'cyan'; text = `دخل من ${t.partyName}`;
                        break;
                    case 'expense':
                        icon = 'arrow-up'; color = 'rose'; text = `صرف إلى ${t.partyName}`;
                        break;
                    case 'purchase_order':
                        icon = 'shopping-cart'; color = 'slate'; text = `وصل شراء من ${t.partyName}`;
                        break;
                    default:
                        icon = 'file-text'; color = 'gray'; text = `عملية غير معروفة`;
                }
                const amountText = (t.type === 'purchase_order' && !t.settings.showPrice) ? '' : `<p class="font-bold text-lg text-${color}-600">${formatCurrency(t.totalAmount)}</p>`;
                return `<div class="flex justify-between items-center p-3 rounded-lg bg-slate-50"><div class="flex items-center gap-3"><span class="p-2 rounded-full bg-${color}-100 text-${color}-600"><i data-feather="${icon}" class="w-4 h-4"></i></span><div><p class="font-bold text-slate-700">${text}</p><p class="text-sm text-slate-500">${formatDate(t.date?.toDate())}</p></div></div>${amountText}</div>`;
            }).join('');
        }

        function renderTransactionsTable() {
            const tableBody = document.getElementById('transactions-table-body');
            tableBody.innerHTML = allTransactions.length === 0 ? '<tr><td colspan="5" class="text-center p-6 text-slate-500">لا توجد سجلات.</td></tr>' : allTransactions.map(t => {
                let typeText, typeColor, amountText;
                switch(t.type) {
                    case 'income':
                        typeText = 'دخل'; typeColor = 'cyan'; amountText = formatCurrency(t.totalAmount);
                        break;
                    case 'expense':
                        typeText = 'صرف'; typeColor = 'rose'; amountText = formatCurrency(t.totalAmount);
                        break;
                    case 'purchase_order':
                        typeText = 'وصل شراء'; typeColor = 'slate'; amountText = (t.settings && t.settings.showPrice) ? formatCurrency(t.totalAmount) : '---';
                        break;
                    default:
                        typeText = 'غير معروف'; typeColor = 'gray'; amountText = '---';
                }
                return `<tr class="border-b hover:bg-slate-50"><td class="p-4"><span class="px-3 py-1 rounded-full text-xs font-semibold bg-${typeColor}-100 text-${typeColor}-800">${typeText}</span></td><td class="p-4 text-slate-700">${formatDate(t.date?.toDate())}</td><td class="p-4 text-slate-700 font-medium">${t.partyName}</td><td class="p-4 text-slate-800 font-bold">${amountText}</td><td class="p-4 text-center"><button data-id="${t.id}" class="print-btn text-indigo-600 hover:underline font-semibold">طباعة</button><button data-id="${t.id}" data-is-debt-payment="${t.isDebtPayment || false}" data-related-debt-id="${t.relatedDebtId || ''}" data-amount="${t.totalAmount}" class="delete-transaction-btn text-red-600 hover:underline font-semibold mr-4">حذف</button></td></tr>`;
            }).join('');
        }
        
        function renderChart() {
            const ctx = document.getElementById('transactionsChart')?.getContext('2d');
            if (!ctx) return;
            const totalIncome = allTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.totalAmount, 0);
            const totalExpenses = allTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.totalAmount, 0);
            const data = { labels: ['الدخل', 'المصروفات'], datasets: [{ data: [totalIncome, totalExpenses], backgroundColor: ['#06b6d4', '#f43f5e'], borderWidth: 0, spacing: 5, borderRadius: 10 }] };
            if (transactionsChart) transactionsChart.destroy();
            transactionsChart = new Chart(ctx, { type: 'doughnut', data, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { padding: 20, font: { family: 'Tajawal' } } } } } });
        }
        
        // --- Transaction Form Logic ---
        function renderTransactionForm(type) { const isIncome = type === 'income'; document.getElementById(`${type}-page`).innerHTML = `<h1 class="text-3xl font-bold text-slate-800 mb-8">إصدار وصل ${isIncome ? 'دخل' : 'صرف'} جديد</h1><form id="${type}-form" class="bg-white p-6 md:p-8 rounded-xl shadow-sm space-y-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><input type="text" id="${type}-party" class="form-input" placeholder="اسم ${isIncome ? 'الدافع' : 'المستلم'}" required><input type="date" id="${type}-date" class="form-input" required></div><div class="border-t pt-6"><h3 class="font-bold text-lg mb-4 text-slate-700">البنود</h3><div class="overflow-x-auto"><table class="w-full min-w-[600px]"><thead class="bg-slate-50"><tr><th class="p-3 text-sm font-semibold text-right text-slate-600">البيان</th><th class="p-3 text-sm font-semibold text-center w-28 text-slate-600">الكمية</th><th class="p-3 text-sm font-semibold text-center w-36 text-slate-600">سعر الوحدة</th><th class="p-3 text-sm font-semibold text-center w-40 text-slate-600">المجموع</th><th class="w-12"></th></tr></thead><tbody id="${type}-items-body"></tbody></table></div><button type="button" id="add-${type}-item-btn" class="btn btn-secondary mt-4"><i data-feather="plus"></i> إضافة بند</button></div><div class="border-t pt-6 flex justify-between items-center"><div class="text-xl font-bold text-slate-800"><span>الإجمالي:</span> <span id="${type}-total-amount">0.00 د.ع</span></div><button type="submit" class="btn btn-primary">حفظ الوصل</button></div></form>`; setupTransactionForm(type); }
        function setupTransactionForm(type) { const form = document.getElementById(`${type}-form`); form.addEventListener('submit', (e) => handleTransactionSubmit(e, type)); document.getElementById(`add-${type}-item-btn`).addEventListener('click', () => { document.getElementById(`${type}-items-body`).appendChild(createItemRow(type)); feather.replace(); }); resetTransactionForm(type); }
        function createItemRow(type) { const row = document.createElement('tr'); row.className = 'item-row border-b'; row.innerHTML = `<td class="p-2"><input type="text" class="form-input description" placeholder="وصف البند" required></td><td class="p-2"><input type="number" class="form-input quantity" value="1" min="1" required></td><td class="p-2"><input type="number" class="form-input price" placeholder="0.00" min="0" step="any" required></td><td class="p-2"><input type="text" class="form-input bg-slate-100 text-center font-semibold total" readonly></td><td class="p-2 text-center"><button type="button" class="remove-item-btn text-slate-400 hover:text-red-500 p-2 rounded-full"><i data-feather="trash-2" class="w-5 h-5"></i></button></td>`; row.querySelector('.remove-item-btn').addEventListener('click', () => { if (row.parentElement.children.length > 1) { row.remove(); updateFormTotal(type); } }); row.querySelectorAll('.quantity, .price').forEach(input => input.addEventListener('input', () => updateRowTotal(row, type))); return row; }
        function updateRowTotal(row, type) { const quantity = parseFloat(row.querySelector('.quantity').value) || 0; const price = parseFloat(row.querySelector('.price').value) || 0; row.querySelector('.total').value = formatCurrency(quantity * price); updateFormTotal(type); }
        function updateFormTotal(type) { let totalAmount = 0; document.querySelectorAll(`#${type}-form .item-row`).forEach(row => { totalAmount += (parseFloat(row.querySelector('.quantity').value) || 0) * (parseFloat(row.querySelector('.price').value) || 0); }); document.getElementById(`${type}-total-amount`).textContent = formatCurrency(totalAmount); }
        function resetTransactionForm(type) { const form = document.getElementById(`${type}-form`); if (!form) return; form.reset(); const itemsBody = document.getElementById(`${type}-items-body`); itemsBody.innerHTML = ''; itemsBody.appendChild(createItemRow(type)); updateFormTotal(type); document.getElementById(`${type}-date`).value = getTodayDateString(); feather.replace(); }
        async function handleTransactionSubmit(event, type) { event.preventDefault(); const form = event.target; const partyName = form.querySelector(`#${type}-party`).value; const date = form.querySelector(`#${type}-date`).value; const items = Array.from(form.querySelectorAll('.item-row')).map(row => ({ description: row.querySelector('.description').value, quantity: parseFloat(row.querySelector('.quantity').value), price: parseFloat(row.querySelector('.price').value), total: (parseFloat(row.querySelector('.quantity').value) || 0) * (parseFloat(row.querySelector('.price').value) || 0) })); if (items.some(it => !it.description || !it.quantity || isNaN(it.price))) { alert("يرجى ملء جميع حقول البنود."); return; } const totalAmount = items.reduce((sum, item) => sum + item.total, 0); try { await addDoc(transactionsCollectionRef, { type, partyName, date: new Date(date), items, totalAmount, createdAt: serverTimestamp() }); showPage('dashboard-page'); window.location.hash = '#dashboard'; } catch (error) { console.error("Error adding document: ", error); alert("حدث خطأ أثناء الحفظ."); } }

        // --- Purchase Order Logic ---
        function renderPurchaseOrderForm() {
            const page = document.getElementById('purchase-order-page');
            page.innerHTML = `
                <h1 class="text-3xl font-bold text-slate-800 mb-2">إصدار وصل مشتريات</h1>
                <p class="text-slate-500 mb-8">هذه الوصولات لا تؤثر على الرصيد المالي العام.</p>
                <form id="purchase-order-form" class="bg-white p-6 md:p-8 rounded-xl shadow-sm space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="text" id="po-party" class="form-input" placeholder="اسم المجهز / المحل" required>
                        <input type="date" id="po-date" class="form-input" required>
                    </div>
                    <div class="border-t pt-6">
                        <h3 class="font-bold text-lg mb-2 text-slate-700">تخصيص الحقول</h3>
                        <div id="po-settings" class="flex flex-wrap gap-x-6 gap-y-2 mb-4">
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="po-show-quantity" class="form-checkbox rounded" checked><span>إظهار الكمية</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="po-show-price" class="form-checkbox rounded" checked><span>إظهار السعر</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="po-show-notes" class="form-checkbox rounded"><span>إظهار الملاحظات</span></label>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="po-table" class="w-full min-w-[600px]">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="p-3 text-sm font-semibold text-right text-slate-600">البيان</th>
                                        <th class="p-3 text-sm font-semibold text-center w-28 text-slate-600 col-quantity">الكمية</th>
                                        <th class="p-3 text-sm font-semibold text-center w-36 text-slate-600 col-price">سعر الوحدة</th>
                                        <th class="p-3 text-sm font-semibold text-center w-40 text-slate-600 col-price">المجموع</th>
                                        <th class="p-3 text-sm font-semibold text-right text-slate-600 col-notes hidden">ملاحظات</th>
                                        <th class="w-12"></th>
                                    </tr>
                                </thead>
                                <tbody id="po-items-body"></tbody>
                            </table>
                        </div>
                        <button type="button" id="add-po-item-btn" class="btn btn-secondary mt-4"><i data-feather="plus"></i> إضافة بند</button>
                    </div>
                    <div class="border-t pt-6 flex justify-between items-center">
                        <div id="po-total-display" class="text-xl font-bold text-slate-800"><span>الإجمالي:</span> <span id="po-total-amount">0.00 د.ع</span></div>
                        <button type="submit" class="btn btn-primary">حفظ الوصل</button>
                    </div>
                </form>
            `;
            setupPurchaseOrderForm();
        }

        function setupPurchaseOrderForm() {
            const form = document.getElementById('purchase-order-form');
            form.addEventListener('submit', handlePurchaseOrderSubmit);
            document.getElementById('add-po-item-btn').addEventListener('click', () => { document.getElementById('po-items-body').appendChild(createPOItemRow()); feather.replace(); });
            
            // Settings Listeners
            const settings = ['quantity', 'price', 'notes'];
            settings.forEach(setting => {
                document.getElementById(`po-show-${setting}`).addEventListener('change', updatePOTableVisibility);
            });

            resetPurchaseOrderForm();
        }

        function updatePOTableVisibility() {
            const showQuantity = document.getElementById('po-show-quantity').checked;
            const showPrice = document.getElementById('po-show-price').checked;
            const showNotes = document.getElementById('po-show-notes').checked;
            
            document.querySelectorAll('#po-table .col-quantity').forEach(el => el.classList.toggle('hidden', !showQuantity));
            document.querySelectorAll('#po-table .col-price').forEach(el => el.classList.toggle('hidden', !showPrice));
            document.querySelectorAll('#po-table .col-notes').forEach(el => el.classList.toggle('hidden', !showNotes));
            document.getElementById('po-total-display').classList.toggle('hidden', !showPrice);
            updatePOTotal();
        }

        function createPOItemRow() {
            const row = document.createElement('tr');
            row.className = 'po-item-row border-b';
            row.innerHTML = `
                <td class="p-2"><input type="text" class="form-input description" placeholder="وصف البند" required></td>
                <td class="p-2 col-quantity"><input type="number" class="form-input quantity" value="1" min="1"></td>
                <td class="p-2 col-price"><input type="number" class="form-input price" placeholder="0.00" min="0" step="any"></td>
                <td class="p-2 col-price"><input type="text" class="form-input bg-slate-100 text-center font-semibold total" readonly></td>
                <td class="p-2 col-notes hidden"><input type="text" class="form-input notes" placeholder="ملاحظات..."></td>
                <td class="p-2 text-center"><button type="button" class="remove-item-btn text-slate-400 hover:text-red-500 p-2 rounded-full"><i data-feather="trash-2" class="w-5 h-5"></i></button></td>
            `;
            row.querySelector('.remove-item-btn').addEventListener('click', () => { if (row.parentElement.children.length > 1) { row.remove(); updatePOTotal(); } });
            row.querySelectorAll('.quantity, .price').forEach(input => input.addEventListener('input', () => updatePORowTotal(row)));
            updatePOTableVisibility(); // Ensure new row respects current visibility
            return row;
        }

        function updatePORowTotal(row) {
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            const price = parseFloat(row.querySelector('.price').value) || 0;
            row.querySelector('.total').value = formatCurrency(quantity * price);
            updatePOTotal();
        }

        function updatePOTotal() {
            let totalAmount = 0;
            if (document.getElementById('po-show-price').checked) {
                document.querySelectorAll('#purchase-order-form .po-item-row').forEach(row => {
                    totalAmount += (parseFloat(row.querySelector('.quantity').value) || 0) * (parseFloat(row.querySelector('.price').value) || 0);
                });
            }
            document.getElementById('po-total-amount').textContent = formatCurrency(totalAmount);
        }

        function resetPurchaseOrderForm() {
            const form = document.getElementById('purchase-order-form');
            if (!form) return;
            form.reset();
            const itemsBody = document.getElementById('po-items-body');
            itemsBody.innerHTML = '';
            itemsBody.appendChild(createPOItemRow());
            updatePOTableVisibility();
            updatePOTotal();
            document.getElementById('po-date').value = getTodayDateString();
            feather.replace();
        }

        async function handlePurchaseOrderSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const partyName = form.querySelector('#po-party').value;
            const date = form.querySelector('#po-date').value;
            
            const settings = {
                showQuantity: form.querySelector('#po-show-quantity').checked,
                showPrice: form.querySelector('#po-show-price').checked,
                showNotes: form.querySelector('#po-show-notes').checked,
            };

            const items = Array.from(form.querySelectorAll('.po-item-row')).map(row => ({
                description: row.querySelector('.description').value,
                quantity: settings.showQuantity ? (parseFloat(row.querySelector('.quantity').value) || 1) : null,
                price: settings.showPrice ? (parseFloat(row.querySelector('.price').value) || 0) : null,
                notes: settings.showNotes ? row.querySelector('.notes').value : null,
                total: settings.showPrice ? ((parseFloat(row.querySelector('.quantity').value) || 0) * (parseFloat(row.querySelector('.price').value) || 0)) : 0
            }));

            if (items.some(it => !it.description)) { alert("يرجى ملء خانة البيان لكل بند."); return; }
            
            const totalAmount = items.reduce((sum, item) => sum + item.total, 0);

            try {
                await addDoc(transactionsCollectionRef, {
                    type: 'purchase_order',
                    partyName,
                    date: new Date(date),
                    items,
                    totalAmount,
                    settings, // Save customization settings
                    createdAt: serverTimestamp()
                });
                showPage('dashboard-page');
                window.location.hash = '#dashboard';
            } catch (error) {
                console.error("Error adding purchase order: ", error);
                alert("حدث خطأ أثناء حفظ وصل المشتريات.");
            }
        }

        // --- Debts Page Logic ---
        function initDebtPage() { document.getElementById('debt-date').value = getTodayDateString(); const debtForm = document.getElementById('debt-form'); debtForm.removeEventListener('submit', handleDebtSubmit); debtForm.addEventListener('submit', handleDebtSubmit); const debtTabs = document.getElementById('debt-tabs'); debtTabs.removeEventListener('click', handleTabClick); debtTabs.addEventListener('click', handleTabClick); const debtsPage = document.getElementById('debts-page'); debtsPage.removeEventListener('click', openDebtDetailsModal); debtsPage.addEventListener('click', openDebtDetailsModal); renderDebtCards(); }
        function handleTabClick(e) { if (e.target.tagName !== 'BUTTON') return; const tab = e.target.dataset.tab; document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab)); document.querySelectorAll('.debt-panel').forEach(panel => panel.classList.toggle('hidden', panel.id !== `${tab}-panel`)); }
        function renderDebtCards() { const receivablesPanel = document.getElementById('receivables-panel'); const payablesPanel = document.getElementById('payables-panel'); if (!receivablesPanel || !payablesPanel) return; const createCardHTML = (d) => { const isReceivable = d.type === 'receivable'; const remainingAmount = d.amount - (d.paidAmount || 0); return `<div data-id="${d.id}" class="debt-card bg-white p-4 rounded-lg shadow-sm flex items-center justify-between gap-4 cursor-pointer hover:shadow-md transition-shadow"><div class="flex items-center gap-4"><span class="p-3 rounded-full ${isReceivable ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'}"><i data-feather="${isReceivable ? 'arrow-down-left' : 'arrow-up-right'}"></i></span><div><p class="font-bold text-slate-800">${d.partyName}</p><p class="text-sm text-slate-500">المتبقي: ${formatCurrency(remainingAmount)}</p></div></div><div class="text-left flex-shrink-0"><p class="font-bold text-lg text-slate-700">${formatCurrency(d.amount)}</p><p class="text-xs text-indigo-600 font-semibold p-1">عرض التفاصيل</p></div></div>`; }; receivablesPanel.innerHTML = allDebts.filter(d => d.type === 'receivable').map(createCardHTML).join('') || `<div class="text-center p-6 text-slate-500">لا توجد ديون مستحقة لك.</div>`; payablesPanel.innerHTML = allDebts.filter(d => d.type === 'payable').map(createCardHTML).join('') || `<div class="text-center p-6 text-slate-500">لا توجد ديون مطلوبة منك.</div>`; feather.replace(); }
        async function handleDebtSubmit(e) { e.preventDefault(); const feedbackEl = document.getElementById('debt-form-feedback'); const type = document.getElementById('debt-type').value; const partyName = document.getElementById('debt-party').value; const amount = parseFloat(document.getElementById('debt-amount').value); const date = document.getElementById('debt-date').value; if (!partyName || isNaN(amount) || amount <= 0 || !date) { feedbackEl.textContent = "يرجى ملء جميع الحقول بشكل صحيح."; feedbackEl.className = 'text-sm font-semibold text-red-600'; return; } try { await addDoc(debtsCollectionRef, { type, partyName, amount, date: new Date(date), status: 'active', createdAt: serverTimestamp(), paidAmount: 0 }); feedbackEl.textContent = 'تم تسجيل الدين بنجاح!'; feedbackEl.className = 'text-sm font-semibold text-green-600'; e.target.reset(); document.getElementById('debt-date').value = getTodayDateString(); setTimeout(() => feedbackEl.textContent = '', 3000); } catch (error) { console.error("Error adding debt: ", error); feedbackEl.textContent = "حدث خطأ أثناء تسجيل الدين."; feedbackEl.className = 'text-sm font-semibold text-red-600'; } }
        
        // --- Transaction Deletion Logic ---
        document.getElementById('transactions-page').addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-transaction-btn');
            if (deleteButton) {
                const transactionId = deleteButton.dataset.id;
                const isDebtPayment = deleteButton.dataset.isDebtPayment === 'true';
                const relatedDebtId = deleteButton.dataset.relatedDebtId;
                const amount = parseFloat(deleteButton.dataset.amount);
                let message = 'هل أنت متأكد من حذف هذه العملية؟';
                if (isDebtPayment) { message += ' سيؤدي هذا إلى التراجع عن دفعة الدين المرتبطة بها وتنشيط الدين من جديد.'; }
                showConfirmationModal(message, async () => {
                    try {
                        const batch = writeBatch(db);
                        const transactionDocRef = doc(transactionsCollectionRef, transactionId);
                        if (isDebtPayment && relatedDebtId) {
                            const debtRef = doc(debtsCollectionRef, relatedDebtId);
                            const debtSnap = await getDoc(debtRef);
                            if (debtSnap.exists()) {
                                const debtData = debtSnap.data();
                                const currentPaid = debtData.paidAmount || 0;
                                const newPaidAmount = Math.max(0, currentPaid - amount);
                                batch.update(debtRef, { paidAmount: newPaidAmount, status: 'active' });
                            }
                        }
                        batch.delete(transactionDocRef);
                        await batch.commit();
                    } catch (error) { console.error("Error deleting transaction and updating debt: ", error); alert("فشل حذف العملية."); }
                });
            }
        });

        // --- Confirmation Modal Logic ---
        const confirmBtn = document.getElementById('confirm-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const confirmationError = document.getElementById('confirmation-error');
        let onConfirmCallback = null;
        function showConfirmationModal(message, onConfirm) {
            document.getElementById('confirmation-message').textContent = message;
            onConfirmCallback = onConfirm;
            confirmationError.classList.add('hidden');
            confirmBtn.disabled = false;
            cancelBtn.disabled = false;
            confirmBtn.querySelector('.btn-text').classList.remove('hidden');
            confirmBtn.querySelector('.spinner').classList.add('hidden');
            confirmationModal.classList.remove('hidden');
            feather.replace();
        }
        confirmBtn.addEventListener('click', async () => {
            if (onConfirmCallback) {
                confirmBtn.disabled = true;
                cancelBtn.disabled = true;
                confirmBtn.querySelector('.btn-text').classList.add('hidden');
                confirmBtn.querySelector('.spinner').classList.remove('hidden');
                confirmationError.classList.add('hidden');
                try {
                    await onConfirmCallback();
                    confirmationModal.classList.add('hidden');
                } catch (error) {
                    console.error("Confirmation callback error:", error);
                    confirmationError.textContent = 'حدث خطأ. يرجى المحاولة مرة أخرى.';
                    confirmationError.classList.remove('hidden');
                } finally {
                    confirmBtn.disabled = false;
                    cancelBtn.disabled = false;
                    confirmBtn.querySelector('.btn-text').classList.remove('hidden');
                    confirmBtn.querySelector('.spinner').classList.add('hidden');
                }
            }
        });
        cancelBtn.addEventListener('click', () => { confirmationModal.classList.add('hidden'); });

        // --- Debt Details Modal Logic ---
        function openDebtDetailsModal(e) {
            const debtCard = e.target.closest('.debt-card');
            if (!debtCard) return;
            const debtId = debtCard.dataset.id;
            currentDebtData.debt = allDebts.find(d => d.id === debtId);
            if (!currentDebtData.debt) return;

            document.getElementById('payment-debt-id').value = debtId;
            document.getElementById('debt-modal-party-name').textContent = currentDebtData.debt.partyName;
            document.getElementById('debt-modal-type-text').textContent = currentDebtData.debt.type === 'receivable' ? 'دين مستحق لك من' : 'دين مطلوب منك إلى';
            document.getElementById('debt-modal-total').textContent = formatCurrency(currentDebtData.debt.amount);
            document.getElementById('payment-date').value = getTodayDateString();

            const paymentsCollectionRef = collection(db, `${debtsCollectionRef.path}/${debtId}/payments`);
            if (debtPaymentsUnsubscribe) debtPaymentsUnsubscribe();
            debtPaymentsUnsubscribe = onSnapshot(query(paymentsCollectionRef), (snapshot) => {
                currentDebtData.payments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDebtModalUI();
            });

            debtDetailsModal.classList.remove('hidden');
        }

        function updateDebtModalUI() {
            const totalPaid = currentDebtData.payments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = currentDebtData.debt.amount - totalPaid;
            
            document.getElementById('debt-modal-paid').textContent = formatCurrency(totalPaid);
            document.getElementById('debt-modal-remaining').textContent = formatCurrency(remaining);
            document.getElementById('payment-amount').max = remaining > 0 ? remaining : 0;
            document.getElementById('payment-amount').value = remaining > 0 ? remaining : 0;
            
            const isSettled = remaining <= 0.001;
            document.getElementById('add-payment-form').style.display = isSettled ? 'none' : 'block';
            document.getElementById('settle-debt-btn').style.display = isSettled ? 'none' : 'block';

            const paymentsList = document.getElementById('debt-payments-list');
            paymentsList.innerHTML = currentDebtData.payments.length === 0 
                ? '<p class="text-center text-slate-500 py-4">لا توجد دفعات مسجلة.</p>'
                : currentDebtData.payments.sort((a,b) => (b.date?.toDate() || 0) - (a.date?.toDate() || 0)).map(p => `
                    <div class="flex justify-between items-center bg-white p-3 rounded-md">
                        <div><p class="font-semibold text-slate-700">${formatCurrency(p.amount)}</p><p class="text-xs text-slate-500">${formatDate(p.date?.toDate())}</p></div>
                        <p class="text-xs text-slate-400">مرتبط بعملية مالية</p>
                    </div>
                `).join('');
            feather.replace();
        }

        async function processPayment(debtId, amount, date) {
            const feedbackEl = document.getElementById('payment-form-feedback');
            feedbackEl.textContent = '';
            if (isNaN(amount) || amount <= 0 || !date) { feedbackEl.textContent = 'الرجاء إدخال مبلغ وتاريخ صحيحين.'; return false; }

            const debtDocRef = doc(debtsCollectionRef, debtId);
            const totalPaidSoFar = currentDebtData.payments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = currentDebtData.debt.amount - totalPaidSoFar;
            
            if (amount > remaining + 0.001) { feedbackEl.textContent = 'مبلغ الدفعة أكبر من المبلغ المتبقي.'; return false; }

            try {
                const batch = writeBatch(db);
                const transactionType = currentDebtData.debt.type === 'receivable' ? 'income' : 'expense';
                const transactionData = { type: transactionType, partyName: currentDebtData.debt.partyName, date: new Date(date), items: [{ description: `دفعة دين - ${currentDebtData.debt.partyName}`, quantity: 1, price: amount, total: amount }], totalAmount: amount, createdAt: serverTimestamp(), isDebtPayment: true, relatedDebtId: debtId, };
                const transactionRef = doc(collection(db, transactionsCollectionRef.path));
                batch.set(transactionRef, transactionData);

                const newTotalPaid = totalPaidSoFar + amount;
                const isSettled = Math.abs(currentDebtData.debt.amount - newTotalPaid) < 0.001;
                batch.update(debtDocRef, { paidAmount: newTotalPaid, status: isSettled ? 'settled' : 'active' });

                const paymentRef = doc(collection(db, `${debtDocRef.path}/payments`));
                batch.set(paymentRef, { amount, date: new Date(date), createdAt: serverTimestamp(), relatedTransactionId: transactionRef.id });

                await batch.commit();

                if (isSettled) { debtDetailsModal.classList.add('hidden'); }
                document.getElementById('add-payment-form').reset();
                document.getElementById('payment-date').value = getTodayDateString();
                return true;
            } catch (error) { console.error("Error processing payment: ", error); feedbackEl.textContent = 'حدث خطأ أثناء معالجة الدفعة.'; return false; }
        }

        document.getElementById('add-payment-form').addEventListener('submit', async (e) => { e.preventDefault(); const debtId = document.getElementById('payment-debt-id').value; const amount = parseFloat(document.getElementById('payment-amount').value); const date = document.getElementById('payment-date').value; await processPayment(debtId, amount, date); });
        document.getElementById('settle-debt-btn').addEventListener('click', async (e) => { e.target.disabled = true; const debtId = document.getElementById('payment-debt-id').value; const totalPaidSoFar = currentDebtData.payments.reduce((sum, p) => sum + p.amount, 0); const remainingAmount = currentDebtData.debt.amount - totalPaidSoFar; const date = getTodayDateString(); if (remainingAmount > 0) { await processPayment(debtId, remainingAmount, date); } e.target.disabled = false; });
        
        async function handleDeleteDebt() {
            const debtId = document.getElementById('payment-debt-id').value;
            if (!debtId) return;

            const deleteBtn = document.getElementById('delete-debt-btn');
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'جار الحذف...';
            
            try {
                const batch = writeBatch(db);
                const debtRef = doc(debtsCollectionRef, debtId);
                
                const relatedTransactions = allTransactions.filter(t => t.isDebtPayment && t.relatedDebtId === debtId);
                relatedTransactions.forEach(t => {
                    batch.delete(doc(transactionsCollectionRef, t.id));
                });

                const paymentsCollectionRef = collection(db, `${debtsCollectionRef.path}/${debtId}/payments`);
                const paymentsSnap = await getDocs(paymentsCollectionRef);
                paymentsSnap.forEach(paymentDoc => {
                    batch.delete(paymentDoc.ref);
                });

                batch.delete(debtRef);
                
                await batch.commit();
                debtDetailsModal.classList.add('hidden');
            } catch (error) {
                console.error("Error completely deleting debt:", error);
                alert("حدث خطأ أثناء حذف الدين.");
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'حذف الدين نهائياً';
            }
        }
        document.getElementById('delete-debt-btn').addEventListener('click', handleDeleteDebt);

        document.getElementById('close-debt-modal-btn').addEventListener('click', () => { debtDetailsModal.classList.add('hidden'); if(debtPaymentsUnsubscribe) debtPaymentsUnsubscribe(); });

        // --- Print Modal Logic ---
        document.querySelector('#app-container').addEventListener('click', (e) => { const printButton = e.target.closest('.print-btn'); if (printButton) { const transaction = allTransactions.find(t => t.id === printButton.dataset.id); if (transaction) { generatePrintContent(transaction); document.getElementById('print-modal').classList.remove('hidden'); } } });
        
        function generatePrintContent(t) {
            let title, headerColor, itemsHtml, footerHtml;
            
            if (t.type === 'purchase_order') {
                title = 'وصل مشتريات';
                headerColor = 'text-slate-600';
                const s = t.settings;
                const headers = ['البيان', s.showQuantity && 'الكمية', s.showPrice && 'سعر الوحدة', s.showPrice && 'المجموع', s.showNotes && 'ملاحظات'].filter(Boolean);
                const itemsTbody = t.items.map(item => {
                    const cells = [
                        `<td class="py-2 px-4">${item.description}</td>`,
                        s.showQuantity && `<td class="py-2 px-4 text-center">${item.quantity || ''}</td>`,
                        s.showPrice && `<td class="py-2 px-4 text-center">${formatCurrency(item.price)}</td>`,
                        s.showPrice && `<td class="py-2 px-4 text-center">${formatCurrency(item.total)}</td>`,
                        s.showNotes && `<td class="py-2 px-4">${item.notes || ''}</td>`
                    ].filter(Boolean).join('');
                    return `<tr class="border-b">${cells}</tr>`;
                }).join('');
                itemsHtml = `<table class="w-full text-right mb-6"><thead class="bg-slate-50"><tr>${headers.map(h => `<th class="py-2 px-4 font-semibold text-center">${h}</th>`).join('')}</tr></thead><tbody>${itemsTbody}</tbody></table>`;
                
                if (s.showPrice) {
                    footerHtml = `<div class="w-1/2"><div class="flex justify-between py-2 px-4 bg-slate-100 rounded-t-lg"><span class="font-semibold text-slate-800">المبلغ الإجمالي</span><span class="font-semibold text-slate-800">${formatCurrency(t.totalAmount)}</span></div></div>`;
                } else {
                    footerHtml = '';
                }

            } else { // Income and Expense
                const isIncome = t.type === 'income';
                title = isIncome ? 'وصل قبض' : 'وصل صرف';
                headerColor = isIncome ? 'text-cyan-600' : 'text-rose-600';
                itemsHtml = `<table class="w-full text-right mb-6"><thead class="bg-slate-50"><tr><th class="py-2 px-4 font-semibold">البيان</th><th class="py-2 px-4 font-semibold text-center">الكمية</th><th class="py-2 px-4 font-semibold text-center">سعر الوحدة</th><th class="py-2 px-4 font-semibold text-center">المجموع</th></tr></thead><tbody>${t.items.map(item => `<tr class="border-b"><td class="py-2 px-4">${item.description}</td><td class="py-2 px-4 text-center">${item.quantity}</td><td class="py-2 px-4 text-center">${formatCurrency(item.price)}</td><td class="py-2 px-4 text-center">${formatCurrency(item.total)}</td></tr>`).join('')}</tbody></table>`;
                footerHtml = `<div class="w-1/2"><div class="flex justify-between py-2 px-4 bg-slate-100 rounded-t-lg"><span class="font-semibold text-slate-800">المبلغ الإجمالي</span><span class="font-semibold text-slate-800">${formatCurrency(t.totalAmount)}</span></div><div class="py-4 px-4 border-l border-r border-b rounded-b-lg"><p class="font-bold">المبلغ كتابةً:</p><p class="text-slate-600">... قيد التطوير ...</p></div><div class="mt-16 text-center"><p class="border-t pt-2 text-slate-500">توقيع المستلم</p></div></div>`;
            }

            document.getElementById('print-area').innerHTML = `
                <header class="flex justify-between items-start pb-6 border-b-2 mb-6">
                    <div><h1 class="text-4xl font-bold ${headerColor}">${title}</h1><p class="text-slate-500 mt-2">مرجع: ${t.id.substring(0,10)}</p></div>
                    <div class="text-left"><p class="font-bold text-lg">حساباتي</p><p class="text-slate-600">تاريخ: ${formatDate(t.date?.toDate())}</p></div>
                </header>
                <div class="mb-6"><p class="text-slate-600">${t.type === 'income' ? 'مستلم من:' : (t.type === 'expense' ? 'يُصرف إلى:' : 'من:')}</p><p class="text-xl font-semibold text-slate-800">${t.partyName}</p></div>
                ${itemsHtml}
                <footer class="flex justify-end mt-8">${footerHtml}</footer>
            `;
        }
        document.getElementById('close-print-modal-btn').addEventListener('click', () => document.getElementById('print-modal').classList.add('hidden'));

        // --- Initial App Load ---
        document.addEventListener('DOMContentLoaded', () => { feather.replace(); });
    </script>
</body>
</html>
